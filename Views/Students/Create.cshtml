@model DotNetCoreSqlDb.Models.Student

@{
    ViewData["Title"] = "Create Student";
    var contactTypes = (List<SelectListItem>)ViewBag.ContactTypes ?? new List<SelectListItem>();
}

<h2>Create Student</h2>

@using (Html.BeginForm())
{
    @Html.AntiForgeryToken()

    <div class="form-horizontal">
        <h4>Student</h4>
        <hr />
        <!-- Student fields -->
        <div class="form-group">
            @Html.LabelFor(m => m.Name, new { @class = "control-label col-md-2" })
            <div class="col-md-10">
                @Html.EditorFor(m => m.Name, new { htmlAttributes = new { @class = "form-control" } })
                @Html.ValidationMessageFor(m => m.Name, "", new { @class = "text-danger" })
            </div>
        </div>
        <div class="form-group">
            @Html.LabelFor(m => m.ParentOrEmployer, new { @class = "control-label col-md-2" })
            <div class="col-md-10">
                @Html.EditorFor(m => m.ParentOrEmployer, new { htmlAttributes = new { @class = "form-control" } })
                @Html.ValidationMessageFor(m => m.ParentOrEmployer, "", new { @class = "text-danger" })
            </div>
        </div>
        <div class="form-group">
            @Html.LabelFor(m => m.MainNotes, new { @class = "control-label col-md-2" })
            <div class="col-md-10">
                @Html.EditorFor(m => m.MainNotes, new { htmlAttributes = new { @class = "form-control" } })
                @Html.ValidationMessageFor(m => m.MainNotes, "", new { @class = "text-danger" })
            </div>
        </div>
        <div class="form-group">
            @Html.LabelFor(m => m.OngoingNotes, new { @class = "control-label col-md-2" })
            <div class="col-md-10">
                @Html.EditorFor(m => m.OngoingNotes, new { htmlAttributes = new { @class = "form-control" } })
                @Html.ValidationMessageFor(m => m.OngoingNotes, "", new { @class = "text-danger" })
            </div>
        </div>
        <div class="form-group">
            @Html.LabelFor(m => m.CreatedDate, new { @class = "control-label col-md-2" })
            <div class="col-md-10">
                @Html.EditorFor(m => m.CreatedDate, new { htmlAttributes = new { @class = "form-control" } })
                @Html.ValidationMessageFor(m => m.CreatedDate, "", new { @class = "text-danger" })
            </div>
        </div>

        <h4>Contact Information</h4>
        <!-- Container where finalized contacts (read-only summaries) are placed -->
        <div id="finalizedContacts"></div>
        <!-- Container for the current (active) contact form -->
        <div id="activeContactContainer"></div>

        <!-- Button to add a new contact -->
        <button type="button" id="addContactBtn" class="btn btn-secondary">Add New Contact</button>

        <br /><br />

        <div class="form-group">
            <div class="col-md-offset-2 col-md-10">
                <input type="submit" value="Save" class="btn btn-primary" />
            </div>
        </div>
    </div>
}

<!-- Template for the active (editable) contact form -->
<script id="activeContactTemplate" type="text/template">
<div class="active-contact" data-index="__INDEX__">
    <div class="form-group">
        <label class="control-label col-md-2">Contact Type</label>
        <div class="col-md-10">
            <select name="Contacts[__INDEX__].Type" class="form-control contact-type">
                <option value="">Select Contact Type</option>
            </select>
        </div>
    </div>
    <div class="form-group">
        <label class="control-label col-md-2">Value</label>
        <div class="col-md-10">
            <input type="text" name="Contacts[__INDEX__].Value" class="form-control" />
        </div>
    </div>
    <div class="form-group">
        <label class="control-label col-md-2">Invitation</label>
        <div class="col-md-10">
            <input type="checkbox" name="Contacts[__INDEX__].Invitation" />
        </div>
    </div>
    <div class="form-group">
        <label class="control-label col-md-2">Emergency</label>
        <div class="col-md-10">
            <input type="checkbox" name="Contacts[__INDEX__].Emergency" />
        </div>
    </div>
    <div class="form-group">
        <label class="control-label col-md-2">Money</label>
        <div class="col-md-10">
            <input type="checkbox" name="Contacts[__INDEX__].Money" />
        </div>
    </div>
</div>
</script>

<!-- Template for populating contact type options -->
<script id="contactOptions" type="text/template">
    @foreach (var ct in contactTypes)
    {
        <option value="@ct.Value">@ct.Text</option>
    }
</script>

@section Scripts {
    <script>
        $(function() {
            var contactIndex = 0;

            // When "Add New Contact" is clicked
            $("#addContactBtn").click(function() {
                finalizeActiveContact();
                createActiveContact();
            });

            // Finalize the active contact by converting it into a read-only summary,
            // while hiding its input fields so they still post on submission.
            function finalizeActiveContact() {
                var $active = $("#activeContactContainer .active-contact");
                if ($active.length === 0) {
                    return;
                }

                var idx = $active.data("index");
                var type = $active.find("select[name='Contacts[" + idx + "].Type'] option:selected").text();
                var val = $active.find("input[name='Contacts[" + idx + "].Value']").val();
                var invit = $active.find("input[name='Contacts[" + idx + "].Invitation']").prop("checked");
                var emerg = $active.find("input[name='Contacts[" + idx + "].Emergency']").prop("checked");
                var money = $active.find("input[name='Contacts[" + idx + "].Money']").prop("checked");

                var checks = [];
                if (invit) checks.push("Invitation");
                if (emerg) checks.push("Emergency");
                if (money) checks.push("Money");

                var summary = "[Contact #" + idx + ": " + type + " " + val;
                if (checks.length > 0) {
                    summary += " (" + checks.join(", ") + ")";
                }
                summary += "]";

                // Create a container for the finalized contact
                var $final = $("<div class='finalized-contact'/>");
                $final.append($("<div class='summary-text'/>").text(summary));

                // Hide the actual inputs so the user cannot change them but they still post
                $active.find("select, input[type='text'], input[type='checkbox']").each(function() {
                    $(this).css("display", "none");
                });
                // Append the hidden inputs and summary text, then remove the active container
                $final.append($active.contents());
                $active.remove();
                $("#finalizedContacts").append($final);
            }

            // Create a new active contact form for user entry
            function createActiveContact() {
                contactIndex++;
                var template = $("#activeContactTemplate").html();
                template = template.replace(/__INDEX__/g, contactIndex);
                var $contact = $(template);
                var optionHtml = $("#contactOptions").html();
                $contact.find("select.contact-type").append(optionHtml);
                $("#activeContactContainer").html($contact);
            }
        });
    </script>
}
